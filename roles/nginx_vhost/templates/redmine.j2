#
# {{ ansible_managed }}
#

upstream redmine {
	server 127.0.0.1:3000;
}

server {
	listen {{ item.listen | default('80') }};
	server_name {{ item.server_name | join(' ')}};

	root /usr/share/redmine/public;
	index index.htm index.html;

	location / {
		try_files $uri $uri/ @redmine;
		location ~* \.(jpg|jpeg|gif|css|png|js|ico|txt)$ {
			proxy_pass http://redmine;
			expires 30d;
		}
	}

	location /plugin_assets/ {
		expires 30d;
		try_files $uri =404;
		alias /var/cache/redmine/default/plugin_assets/;
	}

	location @redmine {
		proxy_set_header   X-Real-IP  $remote_addr;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   Host $http_host;
		proxy_redirect     off;
		proxy_read_timeout 300;
		proxy_pass         http://redmine;
	}

	{% include 'part__log.j2' %}

{% if item.use_pagespeed %}
	include /etc/nginx/helpers/pagespeed;
{% endif %}

}

{% if item.redirect.server_name is defined %}
{% for redirect_server_name in item.redirect.server_name %} 
server {
	server_name {{ redirect_server_name }};
	return 301 http://{{ item.server_name[0] }}$request_uri;
}
{% endfor %}
{% endif %}

# vim:filetype=nginx
